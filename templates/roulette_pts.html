{% extends "base.html" %}

{% block title %}SALLY-E | Ruleta PTS{% endblock %}

{% block extra_head %}
<!-- SDK de Monetag para duplicar premio -->
<script src="//libtl.com/sdk.js" data-zone="10311387" data-sdk="show_10311387"></script>
<style>
/* ==================== RULETA PTS - ULTRA PREMIUM 8K ==================== */

.roulette-container {
    min-height: 100vh;
    padding: var(--space-4);
    padding-bottom: 120px;
    padding-top: 60px;
}

/* Header Section */
.roulette-header {
    text-align: center;
    margin-bottom: var(--space-5);
}

.roulette-title {
    font-size: 1.5rem;
    font-weight: 800;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
    margin-bottom: var(--space-1);
}

.roulette-subtitle {
    color: var(--color-text-tertiary);
    font-size: 0.8125rem;
}

/* PTS Balance Card */
.pts-balance-card {
    background: var(--glass-ultra);
    border: var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-5);
    text-align: center;
    backdrop-filter: blur(20px);
    position: relative;
    overflow: hidden;
}

.pts-balance-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-primary);
}

.pts-label {
    font-size: 0.6875rem;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: var(--space-1);
}

.pts-value {
    font-size: 2rem;
    font-weight: 800;
    background: var(--gradient-secondary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.pts-suffix {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-left: var(--space-1);
}

/* ==================== WHEEL - NUEVO DISE√ëO ==================== */
.wheel-section {
    position: relative;
    margin-bottom: var(--space-5);
    display: flex;
    justify-content: center;
}

.wheel-wrapper {
    position: relative;
    width: 280px;
    height: 280px;
}

/* Glow exterior */
.wheel-glow {
    position: absolute;
    top: -15px;
    left: -15px;
    right: -15px;
    bottom: -15px;
    border-radius: 50%;
    background: conic-gradient(
        from 0deg,
        rgba(0, 102, 255, 0.4),
        rgba(0, 82, 204, 0.4),
        rgba(0, 245, 255, 0.4),
        rgba(0, 64, 255, 0.4),
        rgba(0, 163, 255, 0.4),
        rgba(0, 102, 255, 0.4)
    );
    filter: blur(20px);
    opacity: 0.6;
}

/* Marco exterior */
.wheel-frame {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 50%;
    background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
    padding: 8px;
    box-shadow: 
        0 0 0 3px rgba(0, 102, 255, 0.3),
        0 10px 40px rgba(0, 0, 0, 0.5),
        inset 0 2px 4px rgba(255, 255, 255, 0.1);
}

/* Contenedor interno de la ruleta */
.wheel-inner {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    background: #1a1a2e;
}

/* La ruleta que gira */
.wheel {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}

/* Fondo con segmentos usando conic-gradient */
.wheel-bg {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        from -36deg,
        #0066FF 0deg 72deg,
        #0052CC 72deg 144deg,
        #00CED1 144deg 216deg,
        #0040FF 216deg 288deg,
        #00A3FF 288deg 360deg
    );
}

/* L√≠neas divisorias */
.wheel-lines {
    position: absolute;
    width: 100%;
    height: 100%;
}

.wheel-line {
    position: absolute;
    width: 2px;
    height: 50%;
    background: rgba(255, 255, 255, 0.3);
    left: 50%;
    top: 0;
    transform-origin: bottom center;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
}

/* Labels de los premios */
.wheel-labels {
    position: absolute;
    width: 100%;
    height: 100%;
}

.wheel-label {
    position: absolute;
    left: 50%;
    top: 50%;
    transform-origin: center center;
    font-size: 1.25rem;
    font-weight: 800;
    color: white;
    text-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.8),
        0 0 20px rgba(0, 0, 0, 0.5);
    z-index: 5;
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1;
}

.wheel-label .pts-num {
    font-size: 1.5rem;
    font-weight: 900;
}

.wheel-label .pts-text {
    font-size: 0.625rem;
    font-weight: 600;
    opacity: 0.9;
    letter-spacing: 0.05em;
}

/* Posiciones de labels - cada 72 grados, empezando arriba */
.wheel-label:nth-child(1) { transform: translate(-50%, -50%) rotate(0deg) translateY(-85px) rotate(0deg); }
.wheel-label:nth-child(2) { transform: translate(-50%, -50%) rotate(72deg) translateY(-85px) rotate(-72deg); }
.wheel-label:nth-child(3) { transform: translate(-50%, -50%) rotate(144deg) translateY(-85px) rotate(-144deg); }
.wheel-label:nth-child(4) { transform: translate(-50%, -50%) rotate(216deg) translateY(-85px) rotate(-216deg); }
.wheel-label:nth-child(5) { transform: translate(-50%, -50%) rotate(288deg) translateY(-85px) rotate(-288deg); }

/* Centro de la ruleta */
.wheel-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0066FF 0%, #0052CC 50%, #0040FF 100%);
    border: 3px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
        0 4px 20px rgba(0, 102, 255, 0.5),
        inset 0 2px 10px rgba(255, 255, 255, 0.2),
        inset 0 -2px 10px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
}

.wheel-center:hover:not(.disabled) {
    transform: translate(-50%, -50%) scale(1.08);
    box-shadow: 
        0 6px 30px rgba(0, 102, 255, 0.7),
        inset 0 2px 10px rgba(255, 255, 255, 0.2);
}

.wheel-center:active:not(.disabled) {
    transform: translate(-50%, -50%) scale(0.95);
}

.wheel-center.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: linear-gradient(135deg, #444 0%, #333 100%);
}

.wheel-center-text {
    font-size: 0.75rem;
    font-weight: 800;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* Puntero */
.wheel-pointer {
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
}

.wheel-pointer svg {
    width: 30px;
    height: 40px;
}

/* Animaci√≥n del centro */
.wheel-center:not(.disabled) {
    animation: pulse-center 2s ease-in-out infinite;
}

@keyframes pulse-center {
    0%, 100% { box-shadow: 0 4px 20px rgba(0, 102, 255, 0.5), inset 0 2px 10px rgba(255, 255, 255, 0.2); }
    50% { box-shadow: 0 4px 35px rgba(0, 102, 255, 0.8), inset 0 2px 10px rgba(255, 255, 255, 0.3); }
}

/* Animaciones para notificaciones de anuncio incompleto */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from { 
        transform: scale(0.8) translateY(20px);
        opacity: 0;
    }
    to { 
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 40px rgba(239, 68, 68, 0.4);
    }
    50% { 
        transform: scale(1.05);
        box-shadow: 0 0 60px rgba(239, 68, 68, 0.6);
    }
}

/* Timer Section */
.timer-section {
    background: var(--glass-ultra);
    border: var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-3);
    margin-bottom: var(--space-5);
    text-align: center;
    backdrop-filter: blur(20px);
}

.timer-label {
    font-size: 0.6875rem;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: var(--space-1);
}

.timer-value {
    font-size: 1.25rem;
    font-weight: 700;
    font-family: 'SF Mono', 'Roboto Mono', monospace;
}

.timer-value.ready {
    color: var(--color-success);
}

.timer-value.waiting {
    color: var(--color-warning);
}

/* Prizes List */
.prizes-section {
    background: var(--glass-ultra);
    border: var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    backdrop-filter: blur(20px);
}

.prizes-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-3);
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.prizes-grid {
    display: flex;
    justify-content: space-between;
    gap: var(--space-2);
}

.prize-item {
    flex: 1;
    text-align: center;
    padding: var(--space-2);
    border-radius: var(--radius-sm);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.prize-value {
    font-size: 1.125rem;
    font-weight: 700;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.prize-label {
    font-size: 0.5625rem;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
}

/* ==================== RESULT MODAL ==================== */
.result-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-4);
}

.result-modal-overlay.active {
    display: flex;
}

.result-modal {
    background: var(--color-bg-secondary);
    border: var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    max-width: 320px;
    width: 100%;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.result-modal::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
}

.result-icon {
    width: 70px;
    height: 70px;
    margin: 0 auto var(--space-4);
    background: var(--gradient-primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 40px rgba(0, 102, 255, 0.3);
}

.result-icon svg {
    width: 35px;
    height: 35px;
    color: white;
}

.result-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.result-pts {
    font-size: 2.5rem;
    font-weight: 800;
    background: var(--gradient-secondary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-1);
}

.result-pts-label {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-5);
}

.result-double-section {
    background: rgba(0, 102, 255, 0.1);
    border: 1px solid rgba(0, 102, 255, 0.2);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
}

.result-double-text {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
}

.result-double-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-success);
}

.btn-double {
    width: 100%;
    padding: var(--space-3);
    background: var(--gradient-primary);
    border: none;
    border-radius: var(--radius-md);
    color: white;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: var(--space-3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.btn-double:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0, 102, 255, 0.3);
}

.btn-double:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.btn-double svg {
    width: 18px;
    height: 18px;
}

.btn-claim {
    width: 100%;
    padding: var(--space-3);
    background: var(--color-bg-tertiary);
    border: var(--glass-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-claim:hover {
    background: var(--color-bg-elevated);
    color: var(--color-text-primary);
}

/* Back Button */
.back-btn {
    position: fixed;
    top: var(--space-3);
    left: var(--space-3);
    width: 40px;
    height: 40px;
    background: var(--glass-ultra);
    border: var(--glass-border);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: var(--color-bg-elevated);
}

.back-btn svg {
    width: 18px;
    height: 18px;
    color: var(--color-text-primary);
}

/* Confetti */
.confetti-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 999;
    overflow: hidden;
}

.confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    opacity: 0;
}

/* History Link */
.history-link {
    display: block;
    text-align: center;
    color: var(--color-text-tertiary);
    font-size: 0.6875rem;
    margin-top: var(--space-4);
    text-decoration: none;
}
</style>
{% endblock %}

{% block content %}
<!-- Back Button -->
<a href="/?user_id={{ user_id }}" class="back-btn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
</a>

<div class="roulette-container">
    <!-- Header -->
    <div class="roulette-header">
        <h1 class="roulette-title" data-i18n="roulette_pts_title">Ruleta PTS</h1>
        <p class="roulette-subtitle" data-i18n="roulette_pts_subtitle">Gira gratis y gana puntos</p>
    </div>

    <!-- PTS Balance -->
    <div class="pts-balance-card">
        <div class="pts-label" data-i18n="roulette_your_balance">Tu Balance</div>
        <div>
            <span class="pts-value" id="pts-balance">{{ pts_balance or 0 }}</span>
            <span class="pts-suffix">PTS</span>
        </div>
    </div>

    <!-- Wheel Section -->
    <div class="wheel-section">
        <div class="wheel-wrapper">
            <!-- Glow -->
            <div class="wheel-glow"></div>
            
            <!-- Frame -->
            <div class="wheel-frame">
                <div class="wheel-inner">
                    <!-- Puntero -->
                    <div class="wheel-pointer">
                        <svg viewBox="0 0 30 40" fill="none">
                            <path d="M15 40L0 10L15 0L30 10L15 40Z" fill="url(#pointerGrad)"/>
                            <path d="M15 35L3 12L15 4L27 12L15 35Z" fill="white" opacity="0.3"/>
                            <defs>
                                <linearGradient id="pointerGrad" x1="15" y1="0" x2="15" y2="40">
                                    <stop offset="0%" stop-color="#0066FF"/>
                                    <stop offset="100%" stop-color="#0052CC"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    
                    <!-- Wheel -->
                    <div class="wheel" id="wheel">
                        <!-- Fondo con segmentos -->
                        <div class="wheel-bg"></div>
                        
                        <!-- L√≠neas divisorias -->
                        <div class="wheel-lines">
                            <div class="wheel-line" style="transform: rotate(0deg);"></div>
                            <div class="wheel-line" style="transform: rotate(72deg);"></div>
                            <div class="wheel-line" style="transform: rotate(144deg);"></div>
                            <div class="wheel-line" style="transform: rotate(216deg);"></div>
                            <div class="wheel-line" style="transform: rotate(288deg);"></div>
                        </div>
                        
                        <!-- Labels de premios -->
                        <div class="wheel-labels">
                            <div class="wheel-label">
                                <span class="pts-num">5</span>
                                <span class="pts-text">PTS</span>
                            </div>
                            <div class="wheel-label">
                                <span class="pts-num">7</span>
                                <span class="pts-text">PTS</span>
                            </div>
                            <div class="wheel-label">
                                <span class="pts-num">10</span>
                                <span class="pts-text">PTS</span>
                            </div>
                            <div class="wheel-label">
                                <span class="pts-num">13</span>
                                <span class="pts-text">PTS</span>
                            </div>
                            <div class="wheel-label">
                                <span class="pts-num">15</span>
                                <span class="pts-text">PTS</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Centro / Bot√≥n -->
                    <div class="wheel-center" id="spin-btn" onclick="spinWheel()">
                        <span class="wheel-center-text">GIRAR</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer -->
    <div class="timer-section">
        <div class="timer-label" data-i18n="roulette_next_spin">Proximo giro</div>
        <div class="timer-value" id="timer-display">
            {% if can_spin %}
                <span class="ready" data-i18n="roulette_available">DISPONIBLE</span>
            {% else %}
                <span class="waiting" id="countdown">{{ remaining_time }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Prizes -->
    <div class="prizes-section">
        <div class="prizes-title" data-i18n="roulette_prizes">Premios</div>
        <div class="prizes-grid">
            <div class="prize-item">
                <div class="prize-value">5</div>
                <div class="prize-label">PTS</div>
            </div>
            <div class="prize-item">
                <div class="prize-value">7</div>
                <div class="prize-label">PTS</div>
            </div>
            <div class="prize-item">
                <div class="prize-value">10</div>
                <div class="prize-label">PTS</div>
            </div>
            <div class="prize-item">
                <div class="prize-value">13</div>
                <div class="prize-label">PTS</div>
            </div>
            <div class="prize-item">
                <div class="prize-value">15</div>
                <div class="prize-label">PTS</div>
            </div>
        </div>
    </div>

    <a href="/historial?user_id={{ user_id }}" class="history-link" data-i18n="roulette_view_history">Ver historial</a>
</div>

<!-- Result Modal -->
<div class="result-modal-overlay" id="result-modal">
    <div class="result-modal">
        <div class="result-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
        </div>
        <div class="result-title" data-i18n="roulette_congratulations">Felicitaciones</div>
        <div class="result-pts" id="result-pts">0</div>
        <div class="result-pts-label" data-i18n="roulette_pts_won">PTS Ganados</div>
        
        <div class="result-double-section" id="double-section">
            <div class="result-double-text" data-i18n="roulette_double_title">Duplica viendo un anuncio</div>
            <div class="result-double-value" id="double-value">+0 PTS</div>
        </div>
        
        <button class="btn-double" id="btn-double" onclick="doubleReward()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            <span id="btn-double-text" data-i18n="roulette_double_btn">Duplicar x2</span>
        </button>
        
        <button class="btn-claim" id="btn-claim" onclick="claimReward()" data-i18n="roulette_claim_only">
            Solo reclamar
        </button>
    </div>
</div>

<!-- Confetti Container -->
<div class="confetti-container" id="confetti-container"></div>

<script>
// ==================== RULETA PTS SYSTEM ====================

const PRIZES = [5, 7, 10, 13, 15];
const SEGMENT_ANGLE = 360 / PRIZES.length; // 72 degrees
const COOLDOWN_SECONDS = 20 * 60; // 20 minutes

let isSpinning = false;
let currentPrize = 0;
let canSpin = {{ 'true' if can_spin else 'false' }};
let nextSpinTime = {{ next_spin_timestamp or 0 }};

const userId = window.USER_ID?.toString() ||
               window.Telegram?.WebApp?.initDataUnsafe?.user?.id?.toString() ||
               new URLSearchParams(window.location.search).get('user_id')?.toString();

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateSpinButton();
    if (!canSpin && nextSpinTime > 0) {
        startCountdown();
    }
});

// Spin the wheel
async function spinWheel() {
    if (isSpinning || !canSpin) return;
    
    const spinBtn = document.getElementById('spin-btn');
    const wheel = document.getElementById('wheel');
    
    isSpinning = true;
    spinBtn.classList.add('disabled');
    spinBtn.querySelector('.wheel-center-text').textContent = '...';
    
    if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
    }
    
    try {
        const response = await fetch('/api/roulette-pts/spin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Error al girar');
        }
        
        currentPrize = data.prize;
        const prizeIndex = PRIZES.indexOf(currentPrize);
        
        // Calcular rotaci√≥n para que el premio quede arriba (en el puntero)
        // El segmento 0 (5 PTS) est√° centrado en 0¬∞ (arriba)
        // Para que el segmento N quede arriba, rotamos -(N * SEGMENT_ANGLE)
        const baseRotation = 360 * 6; // 6 vueltas completas
        const targetAngle = prizeIndex * SEGMENT_ANGLE;
        
        // Offset aleatorio DENTRO del segmento (m√°ximo 30¬∞ de cada lado, dejando margen de 6¬∞)
        const maxOffset = (SEGMENT_ANGLE / 2) - 6; // 30¬∞ m√°ximo para no salirse del segmento
        const randomOffset = (Math.random() - 0.5) * 2 * maxOffset;
        
        // Rotaci√≥n final: base - √°ngulo del premio + variaci√≥n
        // Esto hace que el segmento del premio quede en posici√≥n 0¬∞ (arriba, donde est√° el puntero)
        const totalRotation = baseRotation - targetAngle + randomOffset;
        
        wheel.style.transition = 'transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
        wheel.style.transform = `rotate(${totalRotation}deg)`;
        
        setTimeout(() => {
            showResult(currentPrize);
            canSpin = false;
            nextSpinTime = data.next_spin_time;
            startCountdown();
            updateSpinButton();
            document.getElementById('pts-balance').textContent = data.new_balance;
        }, 5500);
        
    } catch (error) {
        console.error('Spin error:', error);
        alert(error.message || t('roulette_spin_error'));
        isSpinning = false;
        spinBtn.classList.remove('disabled');
        spinBtn.querySelector('.wheel-center-text').textContent = t('roulette_spin');
    }
}

// Show result modal
function showResult(prize) {
    const modal = document.getElementById('result-modal');
    document.getElementById('result-pts').textContent = prize;
    document.getElementById('double-value').textContent = `+${prize} PTS`;
    
    // Reset modal state
    document.getElementById('double-section').style.display = 'block';
    document.getElementById('btn-double').style.display = 'flex';
    document.getElementById('btn-double').disabled = false;
    document.getElementById('btn-double-text').textContent = t('roulette_double_btn');
    document.getElementById('btn-claim').textContent = t('roulette_claim_only');
    document.querySelector('.result-title').textContent = t('roulette_congratulations');
    
    modal.classList.add('active');
    createConfetti();
    
    if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
}

// Constante de tiempo m√≠nimo para ver el anuncio completo (15 segundos)
const MIN_AD_WATCH_TIME_MS = 15000; // 15 segundos en milisegundos
const MIN_AD_WATCH_TIME_SEC = 15;

// Variables para el seguimiento del anuncio en la ruleta
let rouletteAdStartTime = null;
let rouletteAdWaiting = false;
let rouletteAdResolve = null;

// Listener de visibilidad para la ruleta
document.addEventListener('visibilitychange', function() {
    if (!rouletteAdWaiting || !rouletteAdStartTime || !rouletteAdResolve) return;
    
    if (document.visibilityState === 'visible') {
        // Usuario volvi√≥ a la p√°gina
        const elapsedTime = Date.now() - rouletteAdStartTime;
        const elapsedSeconds = Math.floor(elapsedTime / 1000);
        
        console.log(`[Ruleta] Usuario regres√≥ despu√©s de ${elapsedSeconds} segundos`);
        
        rouletteAdWaiting = false;
        
        if (elapsedTime >= MIN_AD_WATCH_TIME_MS) {
            rouletteAdResolve({ success: true, watchTime: elapsedTime, watchedSeconds: elapsedSeconds });
        } else {
            const remainingSeconds = MIN_AD_WATCH_TIME_SEC - elapsedSeconds;
            rouletteAdResolve({ 
                success: false, 
                watchTime: elapsedTime,
                watchedSeconds: elapsedSeconds,
                remainingSeconds: remainingSeconds
            });
        }
        
        rouletteAdResolve = null;
        rouletteAdStartTime = null;
    }
});

// Backup con window focus
window.addEventListener('focus', function() {
    if (!rouletteAdWaiting || !rouletteAdStartTime || !rouletteAdResolve) return;
    
    setTimeout(() => {
        if (document.visibilityState === 'visible' && rouletteAdWaiting) {
            const elapsedTime = Date.now() - rouletteAdStartTime;
            const elapsedSeconds = Math.floor(elapsedTime / 1000);
            
            console.log(`[Ruleta-Focus] Usuario regres√≥ despu√©s de ${elapsedSeconds} segundos`);
            
            rouletteAdWaiting = false;
            
            if (elapsedTime >= MIN_AD_WATCH_TIME_MS) {
                rouletteAdResolve({ success: true, watchTime: elapsedTime, watchedSeconds: elapsedSeconds });
            } else {
                const remainingSeconds = MIN_AD_WATCH_TIME_SEC - elapsedSeconds;
                rouletteAdResolve({ 
                    success: false, 
                    watchTime: elapsedTime,
                    watchedSeconds: elapsedSeconds,
                    remainingSeconds: remainingSeconds
                });
            }
            
            rouletteAdResolve = null;
            rouletteAdStartTime = null;
        }
    }, 100);
});

// Mostrar notificaci√≥n premium de anuncio incompleto
function showRouletteAdIncomplete(watchedSeconds, remainingSeconds) {
    // Remover notificaciones anteriores
    const existing = document.querySelector('.roulette-ad-incomplete-overlay');
    if (existing) existing.remove();
    
    const overlay = document.createElement('div');
    overlay.className = 'roulette-ad-incomplete-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(12px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    `;
    
    overlay.innerHTML = `
        <div style="
            background: linear-gradient(135deg, rgba(30, 30, 45, 0.98) 0%, rgba(20, 20, 35, 0.98) 100%);
            border: 2px solid rgba(239, 68, 68, 0.5);
            border-radius: 24px;
            padding: 36px 28px;
            max-width: 340px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 80px rgba(239, 68, 68, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        ">
            <div style="
                width: 80px; height: 80px; 
                margin: 0 auto 24px; 
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.25) 0%, rgba(185, 28, 28, 0.25) 100%); 
                border-radius: 50%; 
                display: flex; align-items: center; justify-content: center; 
                box-shadow: 0 0 40px rgba(239, 68, 68, 0.4);
                animation: pulse 2s ease-in-out infinite;
            ">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            </div>
            
            <h3 style="font-size: 1.375rem; font-weight: 800; color: #EF4444; margin-bottom: 12px; text-shadow: 0 0 20px rgba(239, 68, 68, 0.3);">
                ¬°Anuncio No Completado!
            </h3>
            
            <p style="font-size: 1rem; color: rgba(255, 255, 255, 0.75); margin-bottom: 24px; line-height: 1.6;">
                Debes ver el anuncio completo para duplicar tu premio.
            </p>
            
            <div style="
                background: rgba(239, 68, 68, 0.12); 
                border: 1px solid rgba(239, 68, 68, 0.25); 
                border-radius: 16px; 
                padding: 20px; 
                margin-bottom: 24px;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.5);">‚è±Ô∏è Tiempo visto:</span>
                    <span style="font-size: 1rem; font-weight: 700; color: #EF4444;">${watchedSeconds} seg</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.5);">üéØ Tiempo requerido:</span>
                    <span style="font-size: 1rem; font-weight: 600; color: rgba(255, 255, 255, 0.85);">${MIN_AD_WATCH_TIME_SEC} seg</span>
                </div>
                <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 12px 0;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.9375rem; color: rgba(255, 255, 255, 0.6);">‚ùå Te faltaron:</span>
                    <span style="font-size: 1.125rem; font-weight: 800; color: #EF4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);">${remainingSeconds} segundos</span>
                </div>
            </div>
            
            <button onclick="this.closest('.roulette-ad-incomplete-overlay').remove()" style="
                width: 100%;
                padding: 16px;
                background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
                border: none;
                border-radius: 14px;
                color: white;
                font-size: 1rem;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
            ">
                Entendido
            </button>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Cerrar al hacer clic fuera
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
    });
    
    // Auto-cerrar despu√©s de 6 segundos
    setTimeout(() => {
        if (overlay.parentNode) {
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.3s ease';
            setTimeout(() => overlay.remove(), 300);
        }
    }, 6000);
}

// Double reward with Monetag ad
async function doubleReward() {
    const btnDouble = document.getElementById('btn-double');
    const btnText = document.getElementById('btn-double-text');
    
    btnDouble.disabled = true;
    btnText.textContent = t('roulette_loading_ad');
    
    try {
        // Verificar SDK
        if (typeof window.show_10311387 !== 'function') {
            throw new Error(t('roulette_ads_not_available'));
        }
        
        btnText.textContent = t('roulette_showing_ad');
        
        // Configurar estado para esperar al usuario
        rouletteAdStartTime = Date.now();
        rouletteAdWaiting = true;
        
        console.log('[Ruleta] Iniciando anuncio. Timestamp:', rouletteAdStartTime);
        
        // Mostrar el anuncio
        try {
            show_10311387();
        } catch (e) {
            console.warn('Monetag show error:', e);
        }
        
        // Esperar a que el usuario regrese (usando Promise con los event listeners)
        const adResult = await new Promise((resolve) => {
            rouletteAdResolve = resolve;
            
            // Timeout de seguridad: 120 segundos
            setTimeout(() => {
                if (rouletteAdWaiting) {
                    rouletteAdWaiting = false;
                    rouletteAdResolve = null;
                    rouletteAdStartTime = null;
                    resolve({ success: false, timeout: true, error: 'Tiempo agotado' });
                }
            }, 120000);
        });
        
        console.log('[Ruleta] Resultado del anuncio:', adResult);
        
        // Verificar si el usuario vio el anuncio completo
        if (!adResult.success) {
            // Haptic feedback de error
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
            
            if (adResult.timeout) {
                throw new Error('Tiempo agotado. Intenta de nuevo.');
            }
            
            // Mostrar modal de error premium
            showRouletteAdIncomplete(adResult.watchedSeconds || 0, adResult.remainingSeconds || MIN_AD_WATCH_TIME_SEC);
            
            btnDouble.disabled = false;
            btnText.textContent = t('roulette_double_btn');
            return; // Salir sin dar recompensa
        }
        
        btnText.textContent = t('roulette_validating');
        
        // Duplicar en backend (solo si pas√≥ la validaci√≥n de tiempo)
        const response = await fetch('/api/roulette-pts/double', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                user_id: userId,
                original_prize: currentPrize,
                watch_time: adResult.watchTime
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('pts-balance').textContent = data.new_balance;
            document.getElementById('result-pts').textContent = currentPrize * 2;
            document.querySelector('.result-title').textContent = t('roulette_doubled');
            document.getElementById('double-section').style.display = 'none';
            btnDouble.style.display = 'none';
            document.getElementById('btn-claim').textContent = t('close');
            
            createConfetti();
            
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        } else {
            throw new Error(data.error || t('roulette_double_error'));
        }
        
    } catch (error) {
        console.error('Double error:', error);
        alert(error.message || t('roulette_double_error'));
        btnDouble.disabled = false;
        btnText.textContent = t('roulette_double_btn');
        
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }
}

// Claim reward
function claimReward() {
    const modal = document.getElementById('result-modal');
    modal.classList.remove('active');
    isSpinning = false;
    
    const wheel = document.getElementById('wheel');
    wheel.style.transition = 'none';
    wheel.style.transform = 'rotate(0deg)';
    
    updateSpinButton();
}

// Update spin button
function updateSpinButton() {
    const spinBtn = document.getElementById('spin-btn');
    const btnText = spinBtn.querySelector('.wheel-center-text');
    
    if (canSpin && !isSpinning) {
        spinBtn.classList.remove('disabled');
        btnText.textContent = t('roulette_spin');
    } else {
        spinBtn.classList.add('disabled');
        btnText.textContent = isSpinning ? '...' : t('roulette_wait');
    }
}

// Countdown timer
function startCountdown() {
    const timerDisplay = document.getElementById('timer-display');
    
    function updateTimer() {
        const now = Math.floor(Date.now() / 1000);
        const remaining = nextSpinTime - now;
        
        if (remaining <= 0) {
            canSpin = true;
            timerDisplay.innerHTML = `<span class="ready">${t('roulette_available')}</span>`;
            updateSpinButton();
            
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
            return;
        }
        
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerDisplay.innerHTML = `<span class="waiting">${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}</span>`;
        
        setTimeout(updateTimer, 1000);
    }
    
    updateTimer();
}

// Confetti effect
function createConfetti() {
    const container = document.getElementById('confetti-container');
    const colors = ['#0066FF', '#0052CC', '#00D4FF', '#0040FF', '#00A3FF', '#FFD700'];
    
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.width = (Math.random() * 8 + 4) + 'px';
        confetti.style.height = (Math.random() * 8 + 4) + 'px';
        
        container.appendChild(confetti);
        
        confetti.animate([
            { transform: 'translateY(-20px) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight + 100}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
        ], {
            duration: Math.random() * 2000 + 2000,
            easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
        }).onfinish = () => confetti.remove();
    }
}
</script>
{% endblock %}
