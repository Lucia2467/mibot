{% extends "base.html" %}

{% block title %}SALLY-E | Top Rankings{% endblock %}

{% block content %}
<style>
/* ==================== RANKING PREMIUM STYLES ==================== */
.ranking-hero {
    background: linear-gradient(135deg, rgba(0, 102, 255, 0.1) 0%, rgba(0, 61, 153, 0.15) 100%);
    border: 1px solid rgba(0, 102, 255, 0.2);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.ranking-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #0066FF, #00A3FF, #00D4FF, #00A3FF, #0066FF);
}

.ranking-hero-title {
    font-size: 0.85rem;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
}

.ranking-hero-count {
    font-size: 2.5rem;
    font-weight: 800;
    color: #FFFFFF;
    text-shadow: 0 0 30px rgba(0, 102, 255, 0.5);
}

.ranking-hero-position {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
    padding: 10px 20px;
    background: rgba(0, 102, 255, 0.15);
    border: 1px solid rgba(0, 102, 255, 0.3);
    border-radius: 12px;
}

.ranking-hero-position span {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
}

.ranking-hero-position strong {
    font-size: 1.5rem;
    font-weight: 800;
    color: #00D4FF;
}

/* PODIO PROFESIONAL */
.podium-section {
    margin-bottom: 24px;
}

.podium-container {
    display: flex;
    align-items: flex-end;
    justify-content: center;
    gap: 8px;
    padding: 20px 10px;
    background: linear-gradient(180deg, rgba(0, 102, 255, 0.08) 0%, transparent 100%);
    border-radius: 20px;
    margin-bottom: 16px;
}

.podium-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    max-width: 120px;
}

.podium-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 800;
    color: white;
    margin-bottom: 8px;
    position: relative;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.podium-item.first .podium-avatar {
    width: 80px;
    height: 80px;
    font-size: 2rem;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
    border: 3px solid rgba(255, 215, 0, 0.6);
    box-shadow: 0 0 40px rgba(255, 215, 0, 0.4), 0 8px 30px rgba(0, 0, 0, 0.3);
}

.podium-item.second .podium-avatar {
    background: linear-gradient(135deg, #E8E8E8 0%, #B8B8B8 50%, #A0A0A0 100%);
    border: 3px solid rgba(192, 192, 192, 0.6);
    box-shadow: 0 0 30px rgba(192, 192, 192, 0.3), 0 8px 25px rgba(0, 0, 0, 0.3);
}

.podium-item.third .podium-avatar {
    background: linear-gradient(135deg, #CD7F32 0%, #B87333 50%, #A0522D 100%);
    border: 3px solid rgba(205, 127, 50, 0.6);
    box-shadow: 0 0 30px rgba(205, 127, 50, 0.3), 0 8px 25px rgba(0, 0, 0, 0.3);
}

.podium-name {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--color-text-primary);
    text-align: center;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 4px;
}

.podium-stats {
    font-size: 0.75rem;
    color: var(--color-text-tertiary);
    margin-bottom: 8px;
}

.podium-base {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    border-radius: 12px 12px 0 0;
    position: relative;
}

.podium-item.first .podium-base {
    height: 100px;
    background: linear-gradient(180deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.1) 100%);
    border: 1px solid rgba(255, 215, 0, 0.4);
    border-bottom: none;
}

.podium-item.second .podium-base {
    height: 75px;
    background: linear-gradient(180deg, rgba(192, 192, 192, 0.25) 0%, rgba(192, 192, 192, 0.08) 100%);
    border: 1px solid rgba(192, 192, 192, 0.3);
    border-bottom: none;
}

.podium-item.third .podium-base {
    height: 55px;
    background: linear-gradient(180deg, rgba(205, 127, 50, 0.25) 0%, rgba(205, 127, 50, 0.08) 100%);
    border: 1px solid rgba(205, 127, 50, 0.3);
    border-bottom: none;
}

.podium-rank {
    font-size: 2rem;
    font-weight: 900;
    opacity: 0.3;
    margin-bottom: 8px;
}

.podium-item.first .podium-rank { color: #FFD700; }
.podium-item.second .podium-rank { color: #C0C0C0; }
.podium-item.third .podium-rank { color: #CD7F32; }

.podium-you-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #0066FF;
    color: white;
    font-size: 0.6rem;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 102, 255, 0.4);
}

/* LISTA DE RANKING */
.ranking-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.ranking-list-item {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    background: rgba(8, 8, 18, 0.6);
    border: 1px solid rgba(0, 102, 255, 0.1);
    border-radius: 14px;
    transition: all 0.3s ease;
}

.ranking-list-item:hover {
    background: rgba(0, 102, 255, 0.08);
    border-color: rgba(0, 102, 255, 0.25);
    transform: translateX(4px);
}

.ranking-list-number {
    width: 36px;
    height: 36px;
    background: rgba(0, 102, 255, 0.1);
    border: 1px solid rgba(0, 102, 255, 0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--color-text-secondary);
    margin-right: 14px;
    flex-shrink: 0;
}

.ranking-list-info {
    flex: 1;
    min-width: 0;
}

.ranking-list-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.ranking-list-count {
    font-size: 0.8rem;
    color: var(--color-text-tertiary);
    margin-top: 2px;
}

.ranking-list-badge {
    font-size: 0.7rem;
    font-weight: 600;
    color: #00D4FF;
    background: rgba(0, 212, 255, 0.1);
    padding: 4px 10px;
    border-radius: 8px;
    margin-left: 10px;
}

/* TABS */
.ranking-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    background: rgba(8, 8, 18, 0.6);
    padding: 6px;
    border-radius: 14px;
    border: 1px solid rgba(0, 102, 255, 0.1);
}

.ranking-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    background: transparent;
    border: none;
    border-radius: 10px;
    color: var(--color-text-tertiary);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.ranking-tab:hover {
    color: var(--color-text-secondary);
    background: rgba(0, 102, 255, 0.05);
}

.ranking-tab.active {
    background: linear-gradient(135deg, #003D99 0%, #0066FF 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
}

.ranking-tab svg {
    width: 18px;
    height: 18px;
}
</style>

<div class="container" style="padding-bottom: 120px;">
    
    <!-- SELECTOR DE TABS -->
    <div class="ranking-tabs">
        <button id="tab-referrals" class="ranking-tab active" onclick="switchTab('referrals')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <span data-i18n="ranking_referrals">Referidos</span>
        </button>
        <button id="tab-pts" class="ranking-tab" onclick="switchTab('pts')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            <span data-i18n="ranking_pts_weekly">PTS Semanal</span>
        </button>
    </div>

    <!-- RANKING DE REFERIDOS -->
    <div id="panel-referrals" class="ranking-panel">
        
        <!-- Hero Card - Tu posici√≥n -->
        <div class="ranking-hero">
            <div class="ranking-hero-title" data-i18n="ranking_your_referrals">Tus Referidos</div>
            <div class="ranking-hero-count">{{ user.referral_count }}</div>
            <div class="ranking-hero-position">
                <span data-i18n="ranking_your_position">Tu posici√≥n:</span>
                <strong>#{{ user_rank }}</strong>
            </div>
        </div>

        {% if top_users and top_users|length >= 3 %}
        <!-- PODIO PROFESIONAL -->
        <div class="podium-section">
            <div class="podium-container">
                <!-- 2do Lugar -->
                <div class="podium-item second">
                    <div class="podium-avatar">
                        2
                        {% if top_users[1].user_id == user.user_id %}<span class="podium-you-badge">T√ö</span>{% endif %}
                    </div>
                    <div class="podium-name">{{ top_users[1].username or top_users[1].first_name }}</div>
                    <div class="podium-stats">{{ top_users[1].referral_count }} refs</div>
                    <div class="podium-base">
                        <span class="podium-rank">2</span>
                    </div>
                </div>
                
                <!-- 1er Lugar -->
                <div class="podium-item first">
                    <div class="podium-avatar">
                        1
                        {% if top_users[0].user_id == user.user_id %}<span class="podium-you-badge">T√ö</span>{% endif %}
                    </div>
                    <div class="podium-name">{{ top_users[0].username or top_users[0].first_name }}</div>
                    <div class="podium-stats">{{ top_users[0].referral_count }} refs</div>
                    <div class="podium-base">
                        <span class="podium-rank">1</span>
                    </div>
                </div>
                
                <!-- 3er Lugar -->
                <div class="podium-item third">
                    <div class="podium-avatar">
                        3
                        {% if top_users[2].user_id == user.user_id %}<span class="podium-you-badge">T√ö</span>{% endif %}
                    </div>
                    <div class="podium-name">{{ top_users[2].username or top_users[2].first_name }}</div>
                    <div class="podium-stats">{{ top_users[2].referral_count }} refs</div>
                    <div class="podium-base">
                        <span class="podium-rank">3</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if top_users %}
        <!-- Lista de posiciones 4-10 -->
        <div class="ranking-list">
            {% for item in top_users %}
            {% if loop.index > 3 and loop.index <= 10 %}
            <div class="ranking-list-item">
                <div class="ranking-list-number">{{ loop.index }}</div>
                <div class="ranking-list-info">
                    <div class="ranking-list-name">
                        {{ item.username or item.first_name }}
                        {% if item.user_id == user.user_id %}<span class="ranking-list-badge">T√ö</span>{% endif %}
                    </div>
                    <div class="ranking-list-count">{{ item.referral_count }} <span data-i18n="ranking_referrals">referidos</span></div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- RANKING DE PTS -->
    <div id="panel-pts" class="ranking-panel" style="display: none;">
        
        <!-- Header con info del usuario -->
        <div class="pts-hero-card">
            <div class="pts-hero-bg"></div>
            <div class="pts-hero-content">
                <div class="pts-hero-header">
                    <div>
                        <h3 class="pts-hero-title" data-i18n="ranking_weekly">Ranking Semanal</h3>
                        <p class="pts-hero-subtitle" data-i18n="ranking_compete_doge">Compite por premios en DOGE</p>
                    </div>
                    <div class="pts-countdown-box">
                        <span class="pts-countdown-label" data-i18n="ranking_ends_in">Termina en</span>
                        <div id="pts-countdown" class="pts-countdown-value">-- <span data-i18n="ranking_days">d√≠as</span></div>
                    </div>
                </div>
                
                <div class="pts-user-stats">
                    <div class="pts-user-stat">
                        <span class="pts-user-stat-label" data-i18n="ranking_your_pts_week">Tus PTS esta semana</span>
                        <div class="pts-user-stat-value"><span id="user-pts-week">0</span> PTS</div>
                    </div>
                    <div class="pts-user-stat-divider"></div>
                    <div class="pts-user-stat">
                        <span class="pts-user-stat-label" data-i18n="ranking_your_position">Tu posici√≥n</span>
                        <div class="pts-user-stat-position">#<span id="user-pts-position">--</span></div>
                        <div id="user-prize-status" class="pts-user-prize-status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REGLAS DEL RANKING -->
        <div class="pts-rules-card">
            <div class="pts-rules-header">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                <h3 data-i18n="ranking_weekly_prizes">Premios Semanales</h3>
            </div>
            
            <!-- Regla importante -->
            <div class="pts-min-rule">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                <span data-i18n="ranking_min_pts_rule">M√≠nimo 2,000 PTS para clasificar a premio</span>
            </div>
            
            <!-- Tabla de premios -->
            <div class="pts-prizes-table">
                <div class="pts-prize-row gold">
                    <div class="pts-prize-medal">ü•á</div>
                    <div class="pts-prize-info">
                        <span class="pts-prize-pos">Top 1</span>
                        <span class="pts-prize-desc" data-i18n="ranking_most_pts">M√°s puntos de la semana</span>
                    </div>
                    <div class="pts-prize-reward">5 DOGE</div>
                </div>
                <div class="pts-prize-row silver">
                    <div class="pts-prize-medal">ü•à</div>
                    <div class="pts-prize-info">
                        <span class="pts-prize-pos">Top 2</span>
                        <span class="pts-prize-desc" data-i18n="ranking_second_place">Segundo lugar</span>
                    </div>
                    <div class="pts-prize-reward">2 DOGE</div>
                </div>
                <div class="pts-prize-row bronze">
                    <div class="pts-prize-medal">ü•â</div>
                    <div class="pts-prize-info">
                        <span class="pts-prize-pos">Top 3</span>
                        <span class="pts-prize-desc" data-i18n="ranking_third_place">Tercer lugar</span>
                    </div>
                    <div class="pts-prize-reward">1 DOGE</div>
                </div>
                <div class="pts-prize-row">
                    <div class="pts-prize-medal">4¬∞</div>
                    <div class="pts-prize-info">
                        <span class="pts-prize-pos">Top 4</span>
                        <span class="pts-prize-desc" data-i18n="ranking_fourth_place">Cuarto lugar</span>
                    </div>
                    <div class="pts-prize-reward">0.5 DOGE</div>
                </div>
                <div class="pts-prize-row">
                    <div class="pts-prize-medal">5¬∞</div>
                    <div class="pts-prize-info">
                        <span class="pts-prize-pos">Top 5</span>
                        <span class="pts-prize-desc" data-i18n="ranking_fifth_place">Quinto lugar</span>
                    </div>
                    <div class="pts-prize-reward">0.2 DOGE</div>
                </div>
            </div>
            
            <div class="pts-rules-footer">
                <span data-i18n="ranking_only_top5">Solo los Top 5 con 2,000+ PTS reciben premio</span>
            </div>
        </div>

        <!-- TOP 10 RANKING -->
        <div class="card">
            <h3 class="pts-ranking-title">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#00D4FF" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                <span data-i18n="ranking_top_10">Top 10 de la Semana</span>
            </h3>
            <div id="pts-ranking-list" class="pts-ranking-list">
                <div class="pts-loading">
                    <div class="pts-loading-spinner"></div>
                    <span data-i18n="ranking_loading">Cargando...</span>
                </div>
            </div>
        </div>

        <!-- C√ìMO GANAR PTS -->
        <div class="pts-howto-card">
            <h3 class="pts-howto-title">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#0052CC" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                <span data-i18n="ranking_how_earn_pts">¬øC√≥mo ganar PTS?</span>
            </h3>
            <div class="pts-howto-list">
                <div class="pts-howto-item cyan">
                    <div class="pts-howto-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>
                    <div class="pts-howto-info">
                        <span class="pts-howto-reward">+5 PTS</span>
                        <span class="pts-howto-desc" data-i18n="ranking_per_ad">por cada anuncio visto</span>
                    </div>
                </div>
                <div class="pts-howto-item pink">
                    <div class="pts-howto-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
                    <div class="pts-howto-info">
                        <span class="pts-howto-reward">+10 PTS</span>
                        <span class="pts-howto-desc" data-i18n="ranking_daily_checkin">check-in diario</span>
                    </div>
                </div>
                <div class="pts-howto-item yellow">
                    <div class="pts-howto-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg></div>
                    <div class="pts-howto-info">
                        <span class="pts-howto-reward">+20 PTS</span>
                        <span class="pts-howto-desc" data-i18n="ranking_bonus_5_ads">bonus por 5 anuncios</span>
                    </div>
                </div>
                <div class="pts-howto-item green">
                    <div class="pts-howto-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
                    <div class="pts-howto-info">
                        <span class="pts-howto-reward">+15 PTS</span>
                        <span class="pts-howto-desc" data-i18n="ranking_activate_boost">activar boost de miner√≠a</span>
                    </div>
                </div>
            </div>
            <p class="pts-howto-note" data-i18n="ranking_pts_only_ranking">Los PTS son solo para ranking. No se pueden retirar ni convertir a S-E.</p>
        </div>
    </div>
</div>

<style>
/* Tabs */
.ranking-tab{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;background:transparent;border:none;border-radius:var(--radius-md);color:var(--color-text-tertiary);font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.3s ease}
.ranking-tab.active{background:var(--gradient-primary);color:#fff}
.ranking-tab:not(.active):hover{background:rgba(255,255,255,0.05);color:var(--color-text-secondary)}
.crown-icon{position:absolute;top:-10px;right:-8px;width:22px;height:22px;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FFD700' stroke='%23B8860B' stroke-width='1'%3E%3Cpath d='M2 4l3 12h14l3-12-6 7-4-9-4 9-6-7zm3 14h14v2H5z'/%3E%3C/svg%3E") center/contain no-repeat}

/* PTS Hero Card */
.pts-hero-card{position:relative;background:linear-gradient(135deg,rgba(0,245,255,0.12) 0%,rgba(0, 82, 204,0.12) 50%,rgba(232,82,170,0.12) 100%);border:1px solid rgba(0,245,255,0.3);border-radius:var(--radius-xl);padding:var(--space-5);margin-bottom:var(--space-4);overflow:hidden}
.pts-hero-bg{position:absolute;top:-50%;right:-20%;width:200px;height:200px;background:radial-gradient(circle,rgba(0,245,255,0.15) 0%,transparent 70%);border-radius:50%;animation:float 8s ease-in-out infinite}
.pts-hero-content{position:relative;z-index:1}
.pts-hero-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:var(--space-4)}
.pts-hero-title{font-size:1.25rem;font-weight:800;color:var(--color-text-primary);margin:0 0 4px}
.pts-hero-subtitle{font-size:0.85rem;color:var(--color-text-tertiary);margin:0}
.pts-countdown-box{text-align:right}
.pts-countdown-label{font-size:0.75rem;color:var(--color-text-muted)}
.pts-countdown-value{font-size:1.1rem;font-weight:700;color:var(--color-neon-cyan)}
.pts-user-stats{display:flex;align-items:center;justify-content:space-between;padding:var(--space-4);background:var(--glass-ultra);border-radius:var(--radius-lg);border:1px solid var(--glass-border)}
.pts-user-stat{flex:1}
.pts-user-stat:last-child{text-align:right}
.pts-user-stat-label{display:block;font-size:0.8rem;color:var(--color-text-tertiary);margin-bottom:4px}
.pts-user-stat-value{font-size:1.5rem;font-weight:800;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.pts-user-stat-position{font-size:2rem;font-weight:800;color:var(--color-text-primary)}
.pts-user-stat-divider{width:1px;height:50px;background:var(--glass-border);margin:0 var(--space-4)}
.pts-user-prize-status{font-size:0.8rem;font-weight:600;margin-top:4px}
.pts-user-prize-status.qualifies{color:var(--color-success)}
.pts-user-prize-status.not-qualifies{color:var(--color-warning)}
.pts-user-prize-status.no-prize{color:var(--color-text-muted)}

/* Rules Card */
.pts-rules-card{background:linear-gradient(135deg,rgba(255,215,0,0.08) 0%,rgba(18,18,18,0.95) 100%);border:1px solid rgba(255,215,0,0.25);border-radius:var(--radius-xl);padding:var(--space-5);margin-bottom:var(--space-4)}
.pts-rules-header{display:flex;align-items:center;gap:var(--space-3);margin-bottom:var(--space-4)}
.pts-rules-header h3{font-size:1.1rem;font-weight:700;color:var(--color-text-primary);margin:0}
.pts-min-rule{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:linear-gradient(90deg,rgba(255,71,87,0.15) 0%,rgba(255,71,87,0.05) 100%);border:1px solid rgba(255,71,87,0.3);border-radius:var(--radius-md);margin-bottom:var(--space-4);font-size:0.9rem;font-weight:600;color:#FF4757}
.pts-prizes-table{display:flex;flex-direction:column;gap:var(--space-2)}
.pts-prize-row{display:flex;align-items:center;padding:var(--space-3);background:var(--glass-ultra);border-radius:var(--radius-md);border:1px solid var(--glass-border);transition:all 0.2s ease}
.pts-prize-row.gold{border-color:rgba(255,215,0,0.4);background:linear-gradient(90deg,rgba(255,215,0,0.12) 0%,transparent 60%)}
.pts-prize-row.silver{border-color:rgba(192,192,192,0.4);background:linear-gradient(90deg,rgba(192,192,192,0.1) 0%,transparent 60%)}
.pts-prize-row.bronze{border-color:rgba(205,127,50,0.4);background:linear-gradient(90deg,rgba(205,127,50,0.1) 0%,transparent 60%)}
.pts-prize-medal{width:36px;font-size:1.25rem;text-align:center}
.pts-prize-info{flex:1;display:flex;flex-direction:column}
.pts-prize-pos{font-size:0.95rem;font-weight:700;color:var(--color-text-primary)}
.pts-prize-desc{font-size:0.75rem;color:var(--color-text-muted)}
.pts-prize-reward{font-size:1rem;font-weight:800;color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,0.3)}
.pts-rules-footer{margin-top:var(--space-4);padding-top:var(--space-3);border-top:1px solid var(--glass-border);text-align:center;font-size:0.8rem;color:var(--color-text-muted)}

/* Ranking List */
.pts-ranking-title{display:flex;align-items:center;gap:var(--space-3);font-size:1.1rem;font-weight:700;color:var(--color-text-primary);margin-bottom:var(--space-4)}
.pts-ranking-list{display:flex;flex-direction:column;gap:var(--space-3)}
.pts-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--space-8);color:var(--color-text-tertiary)}
.pts-loading-spinner{width:32px;height:32px;border:3px solid var(--glass-border);border-top-color:var(--color-neon-cyan);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:var(--space-3)}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes float{0%,100%{transform:translate(0,0)}50%{transform:translate(10px,10px)}}

/* Ranking Items */
.pts-rank-item{display:flex;align-items:center;padding:var(--space-4);background:var(--glass-ultra);border-radius:var(--radius-lg);border:1px solid var(--glass-border);transition:all 0.2s ease}
.pts-rank-item.top-1{border:2px solid rgba(255,215,0,0.5);box-shadow:0 0 25px rgba(255,215,0,0.15);background:linear-gradient(135deg,rgba(255,215,0,0.1) 0%,transparent 50%)}
.pts-rank-item.top-2{border-color:rgba(192,192,192,0.5);background:linear-gradient(135deg,rgba(192,192,192,0.08) 0%,transparent 50%)}
.pts-rank-item.top-3{border-color:rgba(205,127,50,0.5);background:linear-gradient(135deg,rgba(205,127,50,0.08) 0%,transparent 50%)}
.pts-rank-item.top-4,.pts-rank-item.top-5{border-color:rgba(0, 82, 204,0.3)}
.pts-rank-item.is-user{background:linear-gradient(135deg,rgba(232,82,170,0.15) 0%,rgba(112,11,73,0.1) 100%)!important;border-color:rgba(232,82,170,0.5)!important}
.pts-rank-item.no-prize-zone{opacity:0.7}
.pts-rank-pos{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:800;color:#fff;margin-right:var(--space-3);flex-shrink:0}
.pts-rank-item.top-1 .pts-rank-pos{background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);position:relative}
.pts-rank-item.top-1 .pts-rank-pos::after{content:'';position:absolute;top:-8px;right:-6px;width:20px;height:20px;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FFD700' stroke='%23B8860B' stroke-width='1'%3E%3Cpath d='M2 4l3 12h14l3-12-6 7-4-9-4 9-6-7zm3 14h14v2H5z'/%3E%3C/svg%3E") center/contain no-repeat}
.pts-rank-item.top-2 .pts-rank-pos{background:linear-gradient(135deg,#C0C0C0 0%,#808080 100%)}
.pts-rank-item.top-3 .pts-rank-pos{background:linear-gradient(135deg,#CD7F32 0%,#8B4513 100%)}
.pts-rank-item.top-4 .pts-rank-pos,.pts-rank-item.top-5 .pts-rank-pos{background:linear-gradient(135deg,#0052CC 0%,#0040FF 100%)}
.pts-rank-item:not(.top-1):not(.top-2):not(.top-3):not(.top-4):not(.top-5) .pts-rank-pos{background:var(--glass-ultra);border:1px solid var(--glass-border);color:var(--color-text-secondary)}
.pts-rank-info{flex:1;min-width:0}
.pts-rank-name{font-size:1rem;font-weight:600;color:var(--color-text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pts-rank-pts{font-size:0.85rem;color:var(--color-neon-cyan);font-weight:600}
.pts-rank-right{text-align:right}
.pts-rank-reward{font-size:1rem;font-weight:800}
.pts-rank-reward.has-reward{color:#FFD700;text-shadow:0 0 8px rgba(255,215,0,0.3)}
.pts-rank-reward.no-reward{color:var(--color-text-muted);font-size:0.85rem}
.pts-rank-status{font-size:0.7rem;margin-top:2px}
.pts-rank-status.qualifies{color:var(--color-success)}
.pts-rank-status.needs-pts{color:var(--color-warning)}
.pts-rank-status.no-prize{color:var(--color-text-muted)}

/* How To Card */
.pts-howto-card{background:linear-gradient(135deg,rgba(0, 82, 204,0.08) 0%,rgba(0, 64, 255,0.08) 100%);border:1px solid rgba(0, 82, 204,0.25);border-radius:var(--radius-xl);padding:var(--space-5);margin-top:var(--space-4)}
.pts-howto-title{display:flex;align-items:center;gap:var(--space-3);font-size:1rem;font-weight:700;color:var(--color-text-primary);margin-bottom:var(--space-4)}
.pts-howto-list{display:flex;flex-direction:column;gap:var(--space-3)}
.pts-howto-item{display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3);background:var(--glass-ultra);border-radius:var(--radius-md)}
.pts-howto-icon{width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
.pts-howto-item.cyan .pts-howto-icon{background:rgba(0,245,255,0.2);color:#00D4FF}
.pts-howto-item.pink .pts-howto-icon{background:rgba(232,82,170,0.2);color:#3B82F6}
.pts-howto-item.yellow .pts-howto-icon{background:rgba(255,184,0,0.2);color:#FFB800}
.pts-howto-item.green .pts-howto-icon{background:rgba(0,255,136,0.2);color:#00FF88}
.pts-howto-info{display:flex;align-items:center;gap:var(--space-2)}
.pts-howto-reward{font-weight:700;font-size:0.95rem}
.pts-howto-item.cyan .pts-howto-reward{color:#00D4FF}
.pts-howto-item.pink .pts-howto-reward{color:#3B82F6}
.pts-howto-item.yellow .pts-howto-reward{color:#FFB800}
.pts-howto-item.green .pts-howto-reward{color:#00FF88}
.pts-howto-desc{font-size:0.85rem;color:var(--color-text-secondary)}
.pts-howto-note{font-size:0.75rem;color:var(--color-text-muted);margin-top:var(--space-4);margin-bottom:0;text-align:center}
</style>

<script>
const userId = new URLSearchParams(window.location.search).get('user_id');
const PRIZES = {1: 5, 2: 2, 3: 1, 4: 0.5, 5: 0.2};
const MIN_PTS = 2000;

function switchTab(tab) {
    document.querySelectorAll('.ranking-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.ranking-panel').forEach(p => p.style.display = 'none');
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('panel-' + tab).style.display = 'block';
    if (tab === 'pts') loadPtsRanking();
}

async function loadPtsRanking() {
    try {
        const resp = await fetch(`/api/pts/ranking?user_id=${userId}`);
        const data = await resp.json();
        
        if (data.success) {
            // Actualizar info del usuario
            if (data.user_rank) {
                document.getElementById('user-pts-week').textContent = data.user_rank.pts || 0;
                document.getElementById('user-pts-position').textContent = data.user_rank.position || '--';
                
                const statusEl = document.getElementById('user-prize-status');
                const pos = data.user_rank.position;
                const pts = data.user_rank.pts || 0;
                
                if (pos && pos <= 5) {
                    if (pts >= MIN_PTS) {
                        statusEl.className = 'pts-user-prize-status qualifies';
                        statusEl.innerHTML = `üéâ ${PRIZES[pos]} DOGE`;
                    } else {
                        statusEl.className = 'pts-user-prize-status not-qualifies';
                        const needsText = window.t ? window.t('ranking_needs_pts') : 'Necesitas';
                        statusEl.innerHTML = `‚ö†Ô∏è ${needsText} ${MIN_PTS - pts} PTS`;
                    }
                } else {
                    statusEl.className = 'pts-user-prize-status no-prize';
                    statusEl.textContent = '';
                }
            }
            
            // Countdown
            if (data.period_info) {
                const daysText = window.t ? window.t('ranking_days') : 'd√≠as';
                document.getElementById('pts-countdown').innerHTML = `${data.period_info.days_remaining} <span>${daysText}</span>`;
            }
            
            // Renderizar ranking
            renderRankingList(data.ranking || []);
        }
    } catch (e) {
        console.error('[Ranking PTS]', e);
        document.getElementById('pts-ranking-list').innerHTML = `
            <div class="pts-loading">
                <span style="color: var(--color-error);">Error al cargar</span>
            </div>
        `;
    }
}

function renderRankingList(ranking) {
    const container = document.getElementById('pts-ranking-list');
    const noParticipantsText = window.t ? window.t('ranking_no_participants') : 'A√∫n no hay participantes';
    const youText = window.t ? window.t('ranking_you') : '(T√∫)';
    const qualifiesText = window.t ? window.t('ranking_qualifies') : '‚úì Califica';
    const needsText = window.t ? window.t('ranking_needs_pts') : 'Necesita';
    const noPrizeText = window.t ? window.t('ranking_no_prize') : 'Sin premio';
    
    if (!ranking || ranking.length === 0) {
        container.innerHTML = `
            <div class="pts-loading">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity:0.3;margin-bottom:var(--space-3)"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                <span>${noParticipantsText}</span>
            </div>
        `;
        return;
    }
    
    let html = '';
    ranking.forEach((e, i) => {
        const pos = i + 1;
        const isTop5 = pos <= 5;
        const topClass = pos === 1 ? 'top-1' : pos === 2 ? 'top-2' : pos === 3 ? 'top-3' : pos === 4 ? 'top-4' : pos === 5 ? 'top-5' : '';
        const isUser = e.user_id == userId;
        const userClass = isUser ? 'is-user' : '';
        const noPrizeZone = !isTop5 ? 'no-prize-zone' : '';
        
        // Determinar estado del premio
        let rewardHtml = '';
        let statusHtml = '';
        
        if (isTop5) {
            const prize = PRIZES[pos];
            if (e.pts >= MIN_PTS) {
                rewardHtml = `<div class="pts-rank-reward has-reward">${prize} DOGE</div>`;
                statusHtml = `<div class="pts-rank-status qualifies">${qualifiesText}</div>`;
            } else {
                const needed = MIN_PTS - e.pts;
                rewardHtml = `<div class="pts-rank-reward no-reward">${prize} DOGE</div>`;
                statusHtml = `<div class="pts-rank-status needs-pts">${needsText} ${needed} PTS</div>`;
            }
        } else {
            rewardHtml = `<div class="pts-rank-reward no-reward">-</div>`;
            statusHtml = `<div class="pts-rank-status no-prize">${noPrizeText}</div>`;
        }
        
        html += `
            <div class="pts-rank-item ${topClass} ${userClass} ${noPrizeZone}">
                <div class="pts-rank-pos">${pos}</div>
                <div class="pts-rank-info">
                    <div class="pts-rank-name">${e.first_name || e.username}${isUser ? ` <span style="color:var(--color-neon-pink);font-size:0.75rem;">${youText}</span>` : ''}</div>
                    <div class="pts-rank-pts">${e.pts.toLocaleString()} PTS</div>
                </div>
                <div class="pts-rank-right">
                    ${rewardHtml}
                    ${statusHtml}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', () => {
    if (typeof lucide !== 'undefined') lucide.createIcons();
    if (new URLSearchParams(window.location.search).get('tab') === 'pts') switchTab('pts');
    
    if (typeof applyTranslations === 'function') {
        setTimeout(applyTranslations, 100);
    }
});
</script>
{% endblock %}
