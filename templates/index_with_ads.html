{% extends "base.html" %}

{% block title %}SALLY-E | Dashboard{% endblock %}

{% block content %}
<!-- Splash Screen Simplificado -->
<div id="splash-screen" class="splash-screen">
    <div class="splash-content">
        <div class="splash-status">
            <span class="status-text">Cargando datos...</span>
        </div>
    </div>
</div>

<div class="container">
    <!-- Hero Balance Card -->
    <div class="card balance-card card-highlight">
        <div class="balance-label">Balance Total</div>
        <div class="balance-amount" id="total-balance">{{ "%.4f"|format(user.se_balance or 0) }}</div>
        <div class="balance-currency">S-E</div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="mining-level">{{ user.mining_level or 1 }}</div>
            <div class="stat-label">Nivel</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="referral-count">{{ user.referral_count or 0 }}</div>
            <div class="stat-label">Referidos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ mining_rate or user.mining_power or 0.02 }}</div>
            <div class="stat-label">S-E/Hora</div>
        </div>
    </div>

    <!-- Mining Card -->
    <div class="card">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="section-title" style="margin-bottom: var(--space-1);">Mining Station</h2>
                <p class="text-muted">Ganancias sin reclamar</p>
            </div>
            <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--gradient-subtle); border-radius: var(--radius-md); border: var(--glass-border);">
                <i data-lucide="zap" style="width: 24px; height: 24px; color: var(--color-neon-pink);"></i>
            </div>
        </div>

        <div style="text-align: center; margin-bottom: var(--space-6);">
            <div style="font-size: 3rem; font-weight: 800; letter-spacing: -0.03em; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: var(--space-2);" id="unclaimed-balance">
                {{ "%.4f"|format(unclaimed or 0) }}
            </div>
            <div style="font-size: 0.875rem; color: var(--color-text-tertiary);">S-E pendientes</div>
        </div>

        <div class="progress mb-4">
            <div class="progress-bar" id="mining-progress" style="width: 0%"></div>
        </div>

        <button class="btn btn-primary btn-lg btn-block" onclick="claimReward()">
            <i data-lucide="arrow-down-to-line" style="width: 20px; height: 20px;"></i>
             Reclamar
        </button>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <h2 class="section-title">Acciones R√°pidas</h2>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3);">
            <a href="/tasks?user_id={{ user_id }}" style="text-decoration: none;">
                <div class="item" style="flex-direction: column; text-align: center; padding: var(--space-5); cursor: pointer;">
                    <div class="item-icon" style="width: 56px; height: 56px; margin-bottom: var(--space-3);">
                        <i data-lucide="check-square" style="width: 28px; height: 28px;"></i>
                    </div>
                    <div class="item-title" style="margin-bottom: 0;">Tareas</div>
                </div>
            </a>

            <a href="/explore?user_id={{ user_id }}" style="text-decoration: none;">
                <div class="item" style="flex-direction: column; text-align: center; padding: var(--space-5); cursor: pointer;">
                    <div class="item-icon" style="width: 56px; height: 56px; margin-bottom: var(--space-3);">
                        <i data-lucide="compass" style="width: 28px; height: 28px;"></i>
                    </div>
                    <div class="item-title" style="margin-bottom: 0;">Explorar</div>
                </div>
            </a>

            <a href="/referidos?user_id={{ user_id }}" style="text-decoration: none;">
                <div class="item" style="flex-direction: column; text-align: center; padding: var(--space-5); cursor: pointer;">
                    <div class="item-icon" style="width: 56px; height: 56px; margin-bottom: var(--space-3);">
                        <i data-lucide="users" style="width: 28px; height: 28px;"></i>
                    </div>
                    <div class="item-title" style="margin-bottom: 0;">Invitar</div>
                </div>
            </a>

            <a href="/wallet?user_id={{ user_id }}" style="text-decoration: none;">
                <div class="item" style="flex-direction: column; text-align: center; padding: var(--space-5); cursor: pointer;">
                    <div class="item-icon" style="width: 56px; height: 56px; margin-bottom: var(--space-3);">
                        <i data-lucide="wallet" style="width: 28px; height: 28px;"></i>
                    </div>
                    <div class="item-title" style="margin-bottom: 0;"> Billetera</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Activity Info -->
    <div class="card">
        <h2 class="section-title">Tu Actividad</h2>

        <div class="item-list">
            <div class="item">
                <div class="item-icon">
                    <i data-lucide="activity"></i>
                </div>
                <div class="item-content">
                    <div class="item-title">Tasa de Miner√≠a</div>
                    <div class="item-subtitle">{{ mining_rate or user.mining_power or 1.0 }} S-E por hora</div>
                </div>
                <div class="item-action">
                    <div class="badge badge-success">Activo</div>
                </div>
            </div>

            <div class="item">
                <div class="item-icon">
                    <i data-lucide="clock"></i>
                </div>
                <div class="item-content">
                    <div class="item-title">√öltima Reclamaci√≥n</div>
                    <div class="item-subtitle">Hace 2 horas</div>
                </div>
            </div>

            <div class="item">
                <div class="item-icon">
                    <i data-lucide="trending-up"></i>
                </div>
                <div class="item-content">
                    <div class="item-title">Nivel Actual</div>
                    <div class="item-subtitle">Nivel {{ user.mining_level or 1 }}</div>
                </div>
                <a href="/upgrade?user_id={{ user_id }}" class="btn btn-secondary btn-sm">
                    Mejorar
                </a>
            </div>
        </div>
    </div>

    <!-- Tips -->
    <div class="card" style="background: rgba(0, 102, 255, 0.05); border-color: rgba(0, 102, 255, 0.1);">
        <div style="display: flex; align-items: flex-start; gap: var(--space-4);">
            <div style="flex-shrink: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(0, 102, 255, 0.1); border-radius: var(--radius-md);">
                <i data-lucide="lightbulb" style="width: 20px; height: 20px; color: var(--color-neon-pink);"></i>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: var(--space-2);"><img src="/static/icons/lightbulb.svg" style="width:20px; height:20px; vertical-align:middle; margin-right:8px;">Consejo Pro</div>
                <div style="font-size: 0.875rem; color: var(--color-text-secondary); line-height: 1.6;">
                    Reclama tus recompensas regularmente y mejora tu nivel de miner√≠a para maximizar tus ganancias diarias.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- AD OVERLAY MODAL - Sistema de Anuncios -->
<!-- ========================================== -->
<div id="ad-overlay" class="ad-overlay">
    <div class="ad-modal">
        <!-- Header del anuncio -->
        <div class="ad-header">
            <div class="ad-header-content">
                <div class="ad-icon-wrapper">
                    <i data-lucide="tv" class="ad-icon"></i>
                </div>
                <h3 class="ad-title">Patrocinador</h3>
                <p class="ad-subtitle">Mira el anuncio para reclamar tu recompensa</p>
            </div>
        </div>
        
        <!-- Contenedor del anuncio -->
        <div class="ad-container" id="ad-container">
            <div class="ad-loading">
                <div class="ad-spinner"></div>
                <span>Cargando anuncio...</span>
            </div>
        </div>
        
        <!-- Footer con contador -->
        <div class="ad-footer">
            <div class="ad-timer-wrapper">
                <div class="ad-timer-bar">
                    <div class="ad-timer-progress" id="ad-timer-progress"></div>
                </div>
                <span class="ad-timer-text" id="ad-timer-text">Preparando...</span>
            </div>
            <button class="ad-close-btn" id="ad-close-btn" disabled onclick="closeAdAndClaim()">
                <i data-lucide="check-circle"></i>
                <span>Continuar</span>
            </button>
        </div>
    </div>
</div>

<!-- Bot√≥n FAB - SOLO APARECE SI HAY C√ìDIGOS ACTIVOS -->
{% if show_promo_fab %}
<button id="promo-fab" onclick="openPromoModal()">
    <!-- TU GIF PERSONALIZADO - CAMBIA ESTA RUTA -->
    <img src="{{ url_for('static', filename='images/promo.gif') }}" alt="C√≥digo Promocional">
</button>
{% endif %}

<!-- Modal de C√≥digo Promocional - DISE√ëO PROFESIONAL -->
<div id="promo-modal" class="promo-modal-overlay">
    <div class="promo-modal-container">
        <!-- Header con gradiente -->
        <div class="promo-modal-header">
            <div class="promo-header-content">
                <div class="promo-icon-wrapper">
                    <i data-lucide="gift" class="promo-icon"></i>
                </div>
                <h2 class="promo-title">C√≥digo Promocional</h2>
                <p class="promo-subtitle">Ingresa tu c√≥digo para recibir recompensas</p>
            </div>
            <button class="promo-close-btn" onclick="closePromoModal()">
                <i data-lucide="x"></i>
            </button>
        </div>

        <!-- Body del modal -->
        <div class="promo-modal-body">
            <div class="promo-input-container">
                <label class="promo-input-label">Tu c√≥digo</label>
                <input 
                    type="text" 
                    id="promo-code-input" 
                    class="promo-input"
                    placeholder="EJEMPLO2024" 
                    maxlength="30"
                    autocomplete="off"
                    autocapitalize="characters">
                <div class="promo-input-hint">Los c√≥digos no distinguen may√∫sculas/min√∫sculas</div>
            </div>

            <button class="promo-submit-btn" onclick="submitPromoCode()" id="promo-submit-btn">
                <i data-lucide="check-circle" class="btn-icon"></i>
                <span>Canjear C√≥digo</span>
            </button>

            <!-- Info box -->
            <div class="promo-info-box">
                <i data-lucide="info" class="info-icon"></i>
                <span>Los c√≥digos son de uso √∫nico y pueden tener l√≠mite de usos</span>
            </div>
        </div>
    </div>
</div>

<style>
/* ===== PROMO FAB BUTTON ===== */
#promo-fab {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 70px;
    height: 70px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 998;
    padding: 0;
    outline: none;
    filter: drop-shadow(0 4px 12px rgba(0, 102, 255, 0.4));
}

#promo-fab img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
    display: block;
}

#promo-fab:hover {
    transform: scale(1.15) rotate(5deg);
    filter: drop-shadow(0 6px 20px rgba(0, 102, 255, 0.6));
}

#promo-fab:active {
    transform: scale(0.95);
}

/* ===== AD OVERLAY STYLES ===== */
.ad-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: adFadeIn 0.3s ease-out;
}

@keyframes adFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.ad-modal {
    background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
    border-radius: 24px;
    max-width: 400px;
    width: 100%;
    overflow: hidden;
    box-shadow: 
        0 25px 60px rgba(0, 0, 0, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.08),
        0 0 100px rgba(0, 245, 255, 0.1);
    animation: adSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes adSlideUp {
    from {
        transform: translateY(40px) scale(0.95);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

/* Ad Header */
.ad-header {
    position: relative;
    padding: 25px 20px 20px;
    background: linear-gradient(135deg, #00D4FF 0%, #0099CC 50%, #006699 100%);
    text-align: center;
}

.ad-header-content {
    position: relative;
    z-index: 1;
}

.ad-icon-wrapper {
    width: 56px;
    height: 56px;
    margin: 0 auto 12px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    animation: adIconPulse 2s ease-in-out infinite;
}

@keyframes adIconPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
    50% { transform: scale(1.05); box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.2); }
}

.ad-icon {
    width: 28px;
    height: 28px;
    color: white;
}

.ad-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    margin: 0 0 6px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.ad-subtitle {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.85);
    margin: 0;
}

/* Ad Container */
.ad-container {
    min-height: 250px;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.ad-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
}

.ad-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(0, 245, 255, 0.2);
    border-top-color: #00D4FF;
    border-radius: 50%;
    animation: adSpin 1s linear infinite;
}

@keyframes adSpin {
    to { transform: rotate(360deg); }
}

/* Ad Footer */
.ad-footer {
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.ad-timer-wrapper {
    margin-bottom: 15px;
}

.ad-timer-bar {
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
}

.ad-timer-progress {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #00D4FF, #00FF88);
    border-radius: 3px;
    transition: width 0.1s linear;
}

.ad-timer-text {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    text-align: center;
    display: block;
}

.ad-close-btn {
    width: 100%;
    padding: 14px 24px;
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.2) 0%, rgba(0, 200, 100, 0.1) 100%);
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 12px;
    color: rgba(0, 255, 136, 0.5);
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: not-allowed;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.ad-close-btn:disabled {
    opacity: 0.5;
}

.ad-close-btn:not(:disabled) {
    background: linear-gradient(135deg, #00FF88 0%, #00CC66 100%);
    border-color: transparent;
    color: #0B0B0F;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
}

.ad-close-btn:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(0, 255, 136, 0.5);
}

.ad-close-btn:not(:disabled):active {
    transform: translateY(0);
}

.ad-close-btn i {
    width: 20px;
    height: 20px;
}

/* ===== PROMO MODAL ===== */
.promo-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.promo-modal-container {
    background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
    border-radius: 24px;
    max-width: 420px;
    width: 100%;
    overflow: hidden;
    box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideUp {
    from {
        transform: translateY(30px) scale(0.95);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

/* Header */
.promo-modal-header {
    position: relative;
    padding: 30px 25px 25px;
    background: linear-gradient(135deg, #003D99 0%, #0066FF 50%, #3B82F6 100%);
    text-align: center;
}

.promo-header-content {
    position: relative;
    z-index: 1;
}

.promo-icon-wrapper {
    width: 60px;
    height: 60px;
    margin: 0 auto 15px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.promo-icon {
    width: 30px;
    height: 30px;
    color: white;
}

.promo-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin: 0 0 8px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.promo-subtitle {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.85);
    margin: 0;
}

.promo-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
}

.promo-close-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: rotate(90deg);
}

.promo-close-btn i {
    width: 20px;
    height: 20px;
}

/* Body */
.promo-modal-body {
    padding: 30px 25px;
}

.promo-input-container {
    margin-bottom: 20px;
}

.promo-input-label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.promo-input {
    width: 100%;
    padding: 18px 20px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 14px;
    color: white;
    font-size: 1.25rem;
    font-weight: 700;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 3px;
    transition: all 0.3s ease;
    font-family: 'Consolas', 'Monaco', monospace;
}

.promo-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
    font-weight: 400;
    letter-spacing: 2px;
}

.promo-input:focus {
    outline: none;
    border-color: #0066FF;
    background: rgba(0, 102, 255, 0.1);
    box-shadow: 
        0 0 0 4px rgba(0, 102, 255, 0.2),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.promo-input-hint {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
    margin-top: 8px;
    text-align: center;
}

/* Submit Button */
.promo-submit-btn {
    width: 100%;
    padding: 18px 24px;
    background: linear-gradient(135deg, #003D99 0%, #0066FF 100%);
    border: none;
    border-radius: 14px;
    color: white;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.promo-submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 102, 255, 0.5);
}

.promo-submit-btn:active {
    transform: translateY(0);
}

.promo-submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.promo-submit-btn .btn-icon {
    width: 20px;
    height: 20px;
}

/* Info Box */
.promo-info-box {
    margin-top: 20px;
    padding: 14px 16px;
    background: linear-gradient(135deg, rgba(0, 245, 255, 0.08) 0%, rgba(0, 102, 255, 0.08) 100%);
    border: 1px solid rgba(0, 245, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
}

.promo-info-box .info-icon {
    width: 18px;
    height: 18px;
    color: var(--color-neon-cyan, #00d4ff);
    flex-shrink: 0;
}

/* Loading state */
.promo-submit-btn.loading {
    pointer-events: none;
}

.promo-submit-btn.loading span {
    opacity: 0;
}

.promo-submit-btn.loading::after {
    content: '';
    position: absolute;
    width: 24px;
    height: 24px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Success state animation */
@keyframes success-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.promo-modal-container.success {
    animation: success-pulse 0.5s ease-out;
}

/* Responsive */
@media (max-width: 480px) {
    .promo-modal-overlay {
        padding: 15px;
    }
    
    .promo-modal-container {
        border-radius: 20px;
    }
    
    .promo-modal-header {
        padding: 25px 20px 20px;
    }
    
    .promo-title {
        font-size: 1.3rem;
    }
    
    .promo-modal-body {
        padding: 25px 20px;
    }
    
    .promo-input {
        font-size: 1.1rem;
        padding: 16px;
    }
    
    #promo-fab {
        width: 60px;
        height: 60px;
        bottom: 80px;
        right: 15px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-update unclaimed balance
function updateUnclaimedBalance() {
    // Usar la tasa efectiva (power * mining_rate global)
    const effectiveRate = {{ mining_rate or user.mining_power or 1.0 }};
    const ratePerSecond = effectiveRate / 3600;
    const unclaimedElement = document.getElementById('unclaimed-balance');
    const progressBar = document.getElementById('mining-progress');

    // El backend YA calcul√≥ el unclaimed real, ahora solo sumamos desde ah√≠
    const initialUnclaimed = {{ unclaimed or 0 }};
    const startTime = Date.now();

    // Actualizar cada segundo
    setInterval(() => {
        if (unclaimedElement) {
            // Calcular segundos desde que carg√≥ la p√°gina
            const secondsPassed = (Date.now() - startTime) / 1000;

            // Sumar al valor inicial que ya incluye todo lo acumulado
            const newValue = initialUnclaimed + (secondsPassed * ratePerSecond);

            unclaimedElement.textContent = newValue.toFixed(4);

            const progress = Math.min((newValue / 100) * 100, 100);
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }
    }, 1000);
}

// Claim reward function
async function claimReward() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');

    if (!userId) {
        showToast('Error: Usuario no identificado', 'error');
        return;
    }

    // Get current unclaimed amount
    const unclaimedAmount = parseFloat(document.getElementById('unclaimed-balance').textContent);
    
    if (unclaimedAmount <= 0) {
        showToast('No hay ganancias para reclamar', 'warning');
        return;
    }

    // Store data for after ad
    window.pendingClaimData = {
        userId: userId,
        amount: unclaimedAmount
    };

    // Show ad first
    showAdOverlay();
}

// ========================================
// AD SYSTEM FUNCTIONS - INTERSTITIAL FOR MINING CLAIM
// Uses Unit ID: int-19115 (Interstitial)
// NO REWARD is granted - this is just an ad before claim
// ========================================

let adTimer = null;
let adTimeRemaining = 5; // Seconds to wait before allowing close
const AD_WAIT_TIME = 5;

function showAdOverlay() {
    const overlay = document.getElementById('ad-overlay');
    const closeBtn = document.getElementById('ad-close-btn');
    const timerProgress = document.getElementById('ad-timer-progress');
    const timerText = document.getElementById('ad-timer-text');
    
    // Reset state
    closeBtn.disabled = true;
    timerProgress.style.width = '0%';
    adTimeRemaining = AD_WAIT_TIME;
    
    // Show overlay
    overlay.style.display = 'flex';
    
    // Reinitialize Lucide icons in the modal
    if (window.lucide) {
        lucide.createIcons();
    }
    
    // Haptic feedback
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
    
    // ============================================
    // INTERSTITIAL AD FOR MINING CLAIM
    // Uses showInterstitialAd() - Unit ID: int-19115
    // NO reward is granted - this is purely for monetization
    // ============================================
    try {
        if (window.showInterstitialAd) {
            // Show interstitial ad (no reward)
            window.showInterstitialAd()
                .then((result) => {
                    if (result.success && result.shown) {
                        console.log('‚úÖ [Mining Claim] Interstitial ad shown successfully');
                    } else {
                        console.log('‚ö†Ô∏è [Mining Claim] Interstitial not shown:', result.reason);
                    }
                })
                .catch((error) => {
                    console.warn('‚ö†Ô∏è [Mining Claim] Interstitial error:', error);
                });
            
            console.log('üì∫ [Mining Claim] Interstitial ad triggered (int-19115)');
        } else {
            console.log('‚ö†Ô∏è [Mining Claim] Interstitial ad system not ready');
        }
    } catch (e) {
        console.warn('‚ö†Ô∏è [Mining Claim] Error showing interstitial:', e);
    }
    
    // Start countdown timer (independent of ad completion)
    timerText.textContent = `Espera ${adTimeRemaining} segundos...`;
    
    adTimer = setInterval(() => {
        adTimeRemaining--;
        const progress = ((AD_WAIT_TIME - adTimeRemaining) / AD_WAIT_TIME) * 100;
        timerProgress.style.width = progress + '%';
        
        if (adTimeRemaining > 0) {
            timerText.textContent = `Espera ${adTimeRemaining} segundos...`;
        } else {
            // Enable close button
            clearInterval(adTimer);
            timerText.textContent = '¬°Listo! Puedes continuar';
            closeBtn.disabled = false;
            
            // Reinitialize icons to update the button
            if (window.lucide) {
                lucide.createIcons();
            }
            
            // Haptic feedback for completion
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }
    }, 1000);
}

function closeAdAndClaim() {
    const overlay = document.getElementById('ad-overlay');
    
    // Clear timer if still running
    if (adTimer) {
        clearInterval(adTimer);
        adTimer = null;
    }
    
    // Hide overlay with animation
    overlay.style.opacity = '0';
    setTimeout(() => {
        overlay.style.display = 'none';
        overlay.style.opacity = '1';
    }, 300);
    
    // Process the actual claim
    if (window.pendingClaimData) {
        processClaimReward(window.pendingClaimData.userId, window.pendingClaimData.amount);
        window.pendingClaimData = null;
    }
}

async function processClaimReward(userId, unclaimedAmount) {
    try {
        // Show ultra professional processing notification
        if (window.showProcessingToast) {
            window.showProcessingToast(
                'Procesando...',
                `¬°Reclamado! +${unclaimedAmount.toFixed(4)} S-E`,
                null,
                1800
            );
        }

        const response = await fetch('/api/claim?user_id=' + userId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('total-balance').textContent = data.new_balance.toFixed(4);
            document.getElementById('unclaimed-balance').textContent = '0.0000';
            document.getElementById('mining-progress').style.width = '0%';

            // Vibrar si est√° disponible
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
            }

            // Marcar que viene de un claim para splash r√°pido
            sessionStorage.setItem('quickReload', 'true');

            // Recargar despu√©s de 3.5 segundos
            setTimeout(() => {
                window.location.reload();
            }, 3500);
        } else {
            showToast(data.message || 'Error al reclamar', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'error');
    }
}

// Abrir modal de c√≥digo promocional
function openPromoModal() {
    const modal = document.getElementById('promo-modal');
    modal.style.display = 'flex';
    
    // Clear and focus input
    const input = document.getElementById('promo-code-input');
    input.value = '';
    setTimeout(() => input.focus(), 100);

    // Re-initialize Lucide icons
    if (window.lucide) {
        lucide.createIcons();
    }

    if (window.vibrateDevice) {
        window.vibrateDevice([10]);
    }

    // Vibraci√≥n de Telegram
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Cerrar modal
function closePromoModal() {
    const modal = document.getElementById('promo-modal');
    modal.style.display = 'none';

    if (window.vibrateDevice) {
        window.vibrateDevice([10]);
    }

    // Vibraci√≥n de Telegram
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
}

// Enviar c√≥digo promocional
async function submitPromoCode() {
    const input = document.getElementById('promo-code-input');
    const btn = document.getElementById('promo-submit-btn');
    const code = input.value.trim().toUpperCase();

    if (!code) {
        if (window.showToast) {
            window.showToast('Por favor ingresa un c√≥digo', 'warning');
        }
        input.focus();
        return;
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.classList.add('loading');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<span>Verificando...</span>';

    try {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id') || (window.Telegram?.WebApp?.initDataUnsafe?.user?.id);

        const response = await fetch('/api/promo/redeem', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                code: code
            })
        });

        const data = await response.json();

        if (data.success) {
            // Success animation
            const container = document.querySelector('.promo-modal-container');
            container.classList.add('success');
            
            if (window.showToast) {
                window.showToast(`üéâ ${data.message || '¬°C√≥digo canjeado!'}`, 'success');
            }
            
            // Vibraci√≥n de √©xito
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }

            // Close modal and reload after delay
            setTimeout(() => {
                closePromoModal();
                container.classList.remove('success');
            }, 1000);
            
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            if (window.showToast) {
                window.showToast(data.error || data.message || 'C√≥digo inv√°lido', 'error');
            }

            // Vibraci√≥n de error
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
            
            // Shake input on error
            input.style.animation = 'shake 0.5s ease';
            setTimeout(() => {
                input.style.animation = '';
                input.select();
            }, 500);
        }

        if (window.vibrateDevice) {
            window.vibrateDevice(data.success ? [10, 50, 10] : [100]);
        }
    } catch (error) {
        console.error('Error:', error);
        if (window.showToast) {
            window.showToast('Error de conexi√≥n', 'error');
        }
    } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.innerHTML = originalContent;
        
        // Re-initialize icons
        if (window.lucide) {
            lucide.createIcons();
        }
    }
}

// Cerrar modal al hacer clic fuera
document.addEventListener('click', function(e) {
    const modal = document.getElementById('promo-modal');
    if (e.target === modal || e.target.classList.contains('promo-modal-overlay')) {
        closePromoModal();
    }
});

// Enter key to submit
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('promo-modal');
    if (modal && modal.style.display === 'flex' && e.key === 'Enter') {
        submitPromoCode();
    }
    if (modal && modal.style.display === 'flex' && e.key === 'Escape') {
        closePromoModal();
    }
});

// Add shake animation
const shakeStyle = document.createElement('style');
shakeStyle.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
`;
document.head.appendChild(shakeStyle);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const splash = document.getElementById('splash-screen');

    // Ocultar splash despu√©s de 1 segundo
    setTimeout(() => {
        splash.style.opacity = '0';
        setTimeout(() => {
            splash.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 300);
    }, 1000);

    // Inicializar iconos
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Iniciar actualizaci√≥n de balance
    setTimeout(() => {
        updateUnclaimedBalance();
    }, 1500);
});
</script>
{% endblock %}
